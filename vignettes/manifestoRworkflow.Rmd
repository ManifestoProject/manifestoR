---
title: "The workflow with the manifestoR package"
author: "Jirka Lewandowski <jirka.lewandowski@wzb.eu>"
date: "27.08.2014"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
---


# Loading the package

First of all, load the `manifestoR` package with the usual R syntax:

```{r eval=FALSE}
library(manifestoR)
```

```{r eval=TRUE, include=FALSE, echo=TRUE}
library(manifestoR)
```
```{r eval=FALSE, include=FALSE}
mp_emptycache()
```

# How to connect to the Manifesto Corpus database

To access the data in the Manifesto Corpus, an account for the Manifesto Project
webpage with an API key is required.
If you do not yet have an account, you can create one at 
[](https://manifesto-project.wzb.eu/signup).
When you have an account, you can create the API key on your profile page.
For every R session using manifestoR and connecting to the Manifesto Corpus database,
you need to set the API key in your work environment.
This can be done by passing either a key or the name of a file containing the
key to the `mp_setapikey()` function (see documentation for details).
Thus, your R script using manifestoR usually will start like this:

```{r eval=FALSE}
library(manifestoR)
mp_setapikey(key.file = "manifesto_apikey.txt")
```
```{r eval=TRUE, include=FALSE}
mp_setapikey(key.file = "../tests/manifesto_apikey.txt")
```

Note that it is a security risk to store the API key file or a script containing
the key in public repositories.

# How to download documents and document sets

Downloading documents works via the function `mp_corpus(...)`.
It takes a `data.frame` listing combinations of party ids and election
dates and returns a `ManifestoCorpus` object, a subtype of the `Corpus` defined
in the package `tm`:

```{r warning=FALSE}
wanted <- data.frame(party=c(41320, 41220), date=c(200909, 200909))
corpus <- mp_corpus(wanted)
print(corpus)
head(content(corpus[[1]]))
```

Note that we received only 1 document, while querying for two.
This is because the party with the id 41220 (KPD) did not run for elections
in September 2009.
Also, not for every party and election data manifesto documents are availabe in the Manifesto Project Corpus.
You can check availability of your query beforehand with the function
`mp_availability(...)`.

The `mp_corpus` function also understands several other formats of
input arguments, for details refer to its documentation.
The party ids (41320 in the example) are the ids as in the Manifesto Project's
main dataset.
They can be found in the current dataset documentation at
[](https://manifesto-project.wzb.eu/datasets)
or in the main dataset, which is also accessible via manifestoR:

```{r cache=FALSE}
mpds <- mp_maindataset()
head(names(mpds)) ## .. and much more
wanted <- subset(mpds,
                 countryname == "Germany" & # see main dataset codebook
                   pervote > 20.0 &
                   edate > as.Date("1990-01-01"))
corpus <- mp_corpus(wanted)
print(corpus)
```

Note how you can use subsets of the main data set directly for querying the corpus
database, since they are already in the right format.

Downloaded documents are automatically cached locally. To learn about
the caching mechanism read the section
[Understanding manifestoR's caching mechanism](#understanding-manifestors-caching-mechanism)
below.

# Working with the CMP codings

The central way for accessing the CMP codings is the accessor method `codes(...)`.
It can be called on `ManifestoDocument`s and `ManifestoCorpus`s and returns a vector
of the CMP codings attached to the quasi-sentences of the document/corpus in a row:

```{r}
doc <- corpus[[7]]
head(codes(doc), n = 15)
head(codes(corpus), n = 15)

```

The coding scheme can be found in the online documentation of the Manifesto
Project dataset at [](https://manifesto-project.wzb.eu/coding_schemes/1).


# Processing the corpus documents

Since the Manifesto Corpus uses the infrastructure of the `tm` package, all
of `tm`s filtering and transforming functionality can be applied directly
to the downloaded `ManifestoCorpus`.

For example, standard natural language processors are available via:

```{r}
corpus.cleaned <- tm_map(corpus, removePunctuation)
corpus.nostop <- tm_map(corpus.cleaned, removeWords, stopwords("german"))
head(content(corpus.nostop[[7]]))
```

For more information about the functionality provided by the `tm`,
please refer to its [documentation](http://cran.r-project.org/web/packages/tm/vignettes/tm.pdf).

Since documents contain many quasi-sentences of which potentially only
specific selections are of interest, `manifestoR` provides a function
for subsetting documents easily:

```{r}
# original document length
length(doc)

# subsetting based on codes
doc.subcodes <- subset(doc, codes(doc) %in% c(202, 503, 607))
length(doc.subcodes)

# subsetting based on text
doc.subtext <- subset(doc, grepl("Demokratie", content(doc)))
head(content(doc.subtext), n = 3)
head(codes(doc.subtext), n = 10)
```


# Understanding manifestoR's caching mechanism

To save time and network traffic, manifestoR saves all downloaded data and
documents locally on your computer and does not connect to the online database
when the same data is requested for the second time.

```{r eval=FALSE}
## connects to online database, might take some seconds:
corpus <- mp_corpus(wanted)

## does not connect to online databse, since only already downloaded documents
## are requested:
subcorpus <- mp_corpus(wanted[3:7,])
```

This has several advantages:

- Internet connection is required only for the first run of a script
- Scripts and analyses stay reproducible also when online database content is updated
- Locally saved data can be copied and exported to other analyses using `manifestoR`
and even other programs (see [next section](#saving-and-exporting-documents))

By default, the file system location of the cached data is the subfolder
"manifestofiles" of the R working directory when `manifestoR` was loaded.
You can find out and change the cache path from within `manifestoR`:

```{r eval=TRUE}
# manifesto.getcachelocation()
# manifesto.setcachelocation("~/new-cache/")
# manifesto.getcachelocation()
```

```{r eval=TRUE, include=FALSE}
# manifesto.setcachelocation(NULL)
```

When you want to update your local data to the most recent version of the
Manifesto Project's corpus and database, you can empty the cache to make
`manifestoR` download the data again the next time you query them.

```{r eval=FALSE}
mp_emptycache()

## connects to online database again
corpus <- mp_corpus(wanted)
```

# Saving and exporting documents

## ... to the file system

TODO `manifesto.copycache()`

TODO describe cache content

## ... within R

TODO `as.data.frame`

... TODO





# Additional Information


## Contributing to manifestoR

... TODO

## Contacting the Manifesto Project team

... TODO


```{r eval=TRUE, include=FALSE}
mp_emptycache()
```
