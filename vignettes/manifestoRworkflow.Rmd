---
title: "The workflow with the manifestoR package"
author: "Jirka Lewandowski <jirka.lewandowski@wzb.eu>"
date: "03/03/2015"
output:
  pdf_document:
    toc: yes
    number_sections: yes
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{The workflow with the manifestoR package}
-->

# Downloading documents from the Manifesto Corpus

## Loading the package

First of all, load the `manifestoR` package with the usual R syntax:

```{r}
library(manifestoR)
```

## Connecting to the Manifesto Project Database API

To access the data in the Manifesto Corpus, an account for the Manifesto Project
webpage with an API key is required.
If you do not yet have an account, you can create one at 
[https://manifesto-project.wzb.eu/signup]().
If you have an account, you can create and download the API key on your profile page.

For every R session using manifestoR and connecting to the Manifesto Corpus database,
you need to set the API key in your work environment.
This can be done by passing either a key or the name of a file containing the
key to manifestoR's `mp_setapikey()` function (see documentation `?mp_setapikey`
for details).
Thus, your R script using manifestoR usually will start like this:

```{r eval=FALSE}
library(manifestoR)
mp_setapikey("manifesto_apikey.txt")
```
```{r eval=TRUE, include=FALSE}
mp_setapikey(key.file = "../tests/manifesto_apikey.txt")
```

This code presumes that you have stored and downloaded the API key in a file
name `manifesto_apikey.txt` in your current R working directory.

Note that it is a security risk to store the API key file or a script containing
the key in public repositories.

## Downloading documents

(Bulk-)Downloading documents works via the function `mp_corpus(...)`.
It can be called with a logical expression specifying the subset of the Manifesto
Corpus that you want to download:

```{r, warning=FALSE}
my_corpus <- mp_corpus(countryname == "Austria" & edate > as.Date("2000-01-01"))
my_corpus
```

`mp_corpus` returns a `ManifestoCorpus` object, a subclass of `Corpus` as defined
in the natural language processing package `tm`.
Following `tm`s logic, a `ManifestoCorpus` consists of `ManifestoDocuments`.
For both, corpus and documents, `tm` provides accessor functions to the corpus
and documents content and metadata:

```{r}
head(content(my_corpus[[1]]))
meta(my_corpus[[1]])
```

For more information on how to use the text mining functions provided by `tm`
for the data from the Manifesto Corpus, refer to the section
[Processing the corpus documents](#processing-the-corpus-documents) below.

The variable names in the logical expression used for querying the corpus
database (`countryname` and `edate` in the example above) can be any column names from the
Manifesto Project's Main Dataset or your current R environment. The Main Dataset
itself is available in manifestoR via the funcion `mp_maindataset()`:

```{r, warning = FALSE}
mpds <- mp_maindataset()
print(head(names(mpds)))
mp_corpus(rile > 60) ## another example of data set based corpus query
```

Alternatively, you can download election programmes on an individual basis
by listing combinations of party ids and election dates in a `data.frame`
and passing it to `mp_corpus(...)`:

```{r warning=FALSE}
wanted <- data.frame(party=c(41220, 41320),
                     date=c(200909, 200909))
mp_corpus(wanted)
```

The party ids (41220 and 41320 in the example) are the ids as in the Manifesto Project's
main dataset.
They can be found in the current dataset documentation at
[https://manifesto-project.wzb.eu/datasets]() or in the main dataset.

Note that we received only 1 document, while querying for two.
This is because the party with the id 41220 (KPD) did not run for elections
in September 2009.
Also, not for every party and election data manifesto documents are availabe in the Manifesto Project Corpus.
You can check availability of your query beforehand with the function
`mp_availability(...)`:
```{r}
mp_availability(party == 41113)
```

Downloaded documents are automatically cached locally. To learn about
the caching mechanism read the section
[Understanding manifestoR's caching mechanism](#understanding-manifestors-caching-mechanism)
below.

## Viewing original documents

Apart from the machine-readable, annotated documents, the Manifesto Corpus also
contains original layouted election programmes in PDF format. If available, they
can be viewed via the function `mp_view_originals(...)`, which takes exactly the
format of arguments as `mp_corpus(...)` ([see above](#downloading-documents)), e.g.:

```{r eval = FALSE}
mp_view_originals(party == 41320 & date == 200909)
```

The original documents are shown in you system's web browser. All URLs opened
by this function refer only to the Manifesto Project's Website. If you want to
open more than 5 PDF documents at once, you have to specify the maximum number
of URLs allows to be opened manually via the parameter `maxn`. Since opening
URLs in an external browser costs computing resources on your local machine,
make sure to use only values for `maxn` that do not slow down or make your computer
unresponsive.

```{r eval = FALSE}
mp_view_originals(party > 41000 & party < 41999, maxn = 20)
```


# Processing and analysing the corpus documents

## Working with the CMP codings

The central way for accessing the CMP codings is the accessor method `codes(...)`.
It can be called on `ManifestoDocument`s and `ManifestoCorpus`s and returns a vector
of the CMP codings attached to the quasi-sentences of the document/corpus in a row:

```{r}
doc <- my_corpus[[2]]
head(codes(doc), n = 15)
head(codes(my_corpus), n = 15)
```

Thus you can for example use R's functionality to count the codes or select quasi-
sentences (units of texts) based on their code:
```{r}
table(codes(doc))

doc_subcodes <- subset(doc, codes(doc) %in% c(202, 503, 607))
length(doc_subcodes)
length(doc_subcodes)/length(doc)
```

The CMP coding scheme can be found in the online documentation of the Manifesto
Project dataset at [https://manifesto-project.wzb.eu/coding_schemes/1]().

## Text mining tools

Since the Manifesto Corpus uses the infrastructure of the `tm` package, all
of `tm`s filtering and transformation functionality can be applied directly
to the downloaded `ManifestoCorpus`.

For example, standard natural language processors are available to clean the corpus:

```{r}
corpus_cleaned <- tm_map(my_corpus, removePunctuation)
corpus_nostop <- tm_map(corpus_cleaned, removeWords, stopwords("german"))
head(content(corpus_nostop[[3]]))
```

So is analysis in form of term document matrices:
```{r}
tdm <- TermDocumentMatrix(corpus_nostop)
inspect(tdm[c("menschen", "wahl", "familie"),])
findAssocs(tdm, "stadt", 0.97) ## find correlated terms, see ?tm::findAssocs
```

For more information about the functionality provided by the `tm`,
please refer to its [documentation](http://cran.r-project.org/web/packages/tm/vignettes/tm.pdf).

## Selecting relevants parts of text

Since documents contain many quasi-sentences of which potentially only
specific selections are of interest, `manifestoR` provides a function
`subset(...)` for subsetting documents easily. It can be used to filter
quasi-sentences based on codes or the text:

```{r}
# subsetting based on codes (as example above)
doc_subcodes <- subset(doc, codes(doc) %in% c(202, 503, 607))
length(doc_subcodes)

# subsetting based on text
doc_subtext <- subset(doc, grepl("Demokratie", content(doc)))
head(content(doc_subtext), n = 3)
head(codes(doc_subtext), n = 10)
```

# Efficiency and reproducibility: manifestoR's caching mechanism

To save time and network traffic, `manifestoR` caches all downloaded data and
documents in your computer's working memory and connects to the online database
only when data is required that has not been downloaded before.

```{r eval=TRUE, include=FALSE}
mp_emptycache()
```

```{r message=TRUE, warning=FALSE}
corpus <- mp_corpus(wanted)
subcorpus <- mp_corpus(wanted[3:7,])
```

Note that in the second query no message informing about the connection to the
Manifesto Project's Database is printed, since no data is actually downloaded.

This mechanism also ensures **reproducibility** of your scripts, analyses
and results: executing your code again will yield the same results, even if
the Manifesto Project's Database is updated in the meantime.
Since the cache is only stored in the working memory, however, in order to ensure
reproducibility across multiple R session, it is advisable to
**save the cache to the hard drive** at the end of analyses and load it in the
beginning:

```{r eval=FALSE}
mp_save_cache(file = "manifesto_cache.RData")

## ... start new R session ... then:

library(manifestoR)
mp_setapikey("manifesto_apikey.txt")
mp_load_cache(file = "manifesto_cache.RData")
```

This way `manifestoR` always works with the same snapshot of the Project
Database and Corpus, saves a lot of unnecessary online traffic and also enables
you to continue with your analyses offline.

For updating locally cached data to the most recent version of the
Manifesto Project Corpus, `manifestoR` provides two functions:

```{r}
mp_check_for_corpus_update()
mp_update_cache()
```

For more detailed information on the caching mechanism and on how to use and load
specific snapshots of the Manifesto Corpus, refer to the R documentations of the
functions mentioned here as well `mp_use_corpus_version`, `mp_corpusversions`,
`mp_which_corpus_version`.


# Exporting documents

If required `ManifestoCorpus` as well as `ManifestoDocument` objects can be
converted to R's internal `data.frame` format and processed further:
```{r}
doc_df <- as.data.frame(doc)
head(doc_df)
```

The function also provides a parameter to include all available metadata in
the export:
```{r}
doc_df_with_meta <- as.data.frame(doc, with.meta = TRUE)
print(names(doc_df_with_meta))
```

Note again that also all functionality provided by `tm`, such as `writeCorpus`
is available on a `ManifestoCorpus`.

# Additional Information

## Contacting the Manifesto Project team

You can get in touch with the Manifesto Project team by e-mailing to
[manifesto-communication@wzb.eu](mailto:manifesto-communication@wzb.eu).
We are happy to receive your feedback and answer questions about the Manifesto
Corpus, including errors or obscurities in the corpus documents as well as bug
reports, feature requests or (planned) source code contributions for the
`manifestoR` package.

For general questions about the Project and dataset, please check the
[Frequently Asked Questions](https://manifesto-project.wzb.eu/questions) section
on our website first.
